# Deployment Guide

## Current Production Setup

### Live URLs
- **Application**: https://aistudyarchitect.com
- **Backend API**: https://ai-study-architect.onrender.com
- **API Docs**: https://ai-study-architect.onrender.com/docs
- **GitHub**: https://github.com/belumume/ai-study-architect

### Hosting Platforms
- **Frontend**: Vercel (free tier)
- **Backend**: Render Starter Plan ($7/month)
- **Database**: PostgreSQL 17 Basic-256mb ($6/month)
- **Domain**: aistudyarchitect.com (custom)

## Automatic Deployment

Both frontend and backend deploy automatically on push to main branch:

```bash
git add .
git commit -m "feat: Your feature"
git push origin main
```

- **Frontend**: GitHub → Vercel (immediate)
- **Backend**: GitHub → Render (2-3 minutes)

## Platform Configuration

### Render Backend Settings
```yaml
Root Directory: backend
Build Command: chmod +x build_starter.sh && ./build_starter.sh
Pre-Deploy Command: # MUST BE EMPTY - leave blank
Start Command: chmod +x start_render.sh && ./start_render.sh
Instance Type: Starter ($7/month)
Database: Basic-256mb ($6/month)
```

### Vercel Frontend Settings
- Framework Preset: Vite
- Build Command: `npm run build`
- Output Directory: `dist`
- Install Command: `npm install`
- Development Command: `npm run dev`

## Environment Variables

### Backend (Render)
```bash
# Auto-configured
DATABASE_URL=postgresql://...

# Required API Keys
ANTHROPIC_API_KEY=sk-ant-xxx
OPENAI_API_KEY=sk-xxx

# Backup System
BACKUP_TOKEN=<match GitHub secret>
BACKUP_ENCRYPTION_KEY=<from password manager>

# R2 (Primary Backup)
R2_ACCOUNT_ID=xxx
R2_ACCESS_KEY=xxx
R2_SECRET_KEY=xxx
R2_BUCKET=ai-study-architect-backups

# S3 (Secondary Backup)
AWS_ACCESS_KEY_ID=xxx
AWS_SECRET_ACCESS_KEY=xxx
AWS_BACKUP_BUCKET=ai-study-architect-backup-2025

# Auto-generated
SECRET_KEY=<auto-generated>
JWT_SECRET_KEY=<auto-generated>
```

### Frontend (Vercel)
```bash
VITE_API_URL=https://ai-study-architect.onrender.com
```

## Database Management

### Connection
```bash
# From Render dashboard
psql $DATABASE_URL

# From local with connection string
psql "postgresql://user:pass@host/dbname"
```

### Migrations
```bash
# Create new migration
alembic revision --autogenerate -m "Description"

# Apply migrations (handled by start_render.sh)
alembic upgrade head
```

### Backup/Restore
```bash
# Trigger backup manually
curl -X POST -H "X-Backup-Token: YOUR_TOKEN" \
  https://ai-study-architect.onrender.com/api/v1/backup/trigger

# Decrypt backup locally
python backend/scripts/decrypt_backup.py backup.enc backup.sql

# Restore locally
psql -U postgres -d ai_study_architect < backup.sql
```

## Monitoring

### Health Checks
```bash
# Backend health
curl https://ai-study-architect.onrender.com/api/v1/health

# Full status
curl https://ai-study-architect.onrender.com/api/v1/health/full
```

### Logs
- **Backend**: Render Dashboard → Logs
- **Frontend**: Vercel Dashboard → Functions → Logs
- **Database**: Render Dashboard → Database → Logs

### Metrics (via Render MCP)
```javascript
// In Claude Code with Render MCP configured
mcp__render__get_metrics({
  resourceId: "srv-xxx",
  metricTypes: ["cpu_usage", "memory_usage", "http_request_count"]
})
```

## Rollback Procedures

### Backend Rollback
1. Go to Render Dashboard
2. Navigate to your service
3. Click "Deploy History"
4. Find previous working deploy
5. Click "Rollback to this deploy"

### Frontend Rollback
1. Go to Vercel Dashboard
2. Select your project
3. Go to "Deployments"
4. Find previous deployment
5. Click "..." → "Promote to Production"

### Database Rollback
```bash
# Download latest backup from R2/S3
# Decrypt it
python backend/scripts/decrypt_backup.py backup.enc backup.sql

# Connect to production database
psql $DATABASE_URL

# Restore (DESTRUCTIVE)
DROP SCHEMA public CASCADE;
CREATE SCHEMA public;
\i backup.sql
```

## Cost Optimization

### Current Monthly Costs
- Render Backend: $7
- PostgreSQL Database: $6
- Vercel Frontend: $0 (free tier)
- **Total**: $13/month

### Scaling Options
- **Upgrade Backend**: Starter → Standard ($25/month) for 2GB RAM
- **Upgrade Database**: Basic → Standard ($22/month) for 1GB RAM
- **Add Redis**: Upstash free tier (10K commands/day)

## Security Checklist

- [ ] API keys rotated quarterly
- [ ] Database backups tested monthly
- [ ] SSL certificates auto-renewed
- [ ] Rate limiting configured
- [ ] CORS properly restricted
- [ ] JWT secrets unique per environment
- [ ] Input validation on all endpoints
- [ ] SQL injection prevention (ORM)
- [ ] XSS protection (React)
- [ ] CSRF tokens on state changes

## Troubleshooting Deployment

### Backend Won't Start
```bash
# Check logs
render logs --service ai-study-architect

# Common fixes:
# 1. Ensure Pre-Deploy is empty
# 2. Check environment variables
# 3. Verify requirements.txt
```

### Frontend Build Fails
```bash
# Check build logs in Vercel dashboard
# Common fixes:
# 1. Clear cache and redeploy
# 2. Check Node version
# 3. Verify dependencies
```

### Database Connection Issues
```bash
# Test connection
psql $DATABASE_URL -c "SELECT 1"

# Common fixes:
# 1. Check connection pool settings
# 2. Verify SSL mode
# 3. Check firewall rules
```

## Emergency Contacts

- **Render Support**: https://render.com/support
- **Vercel Support**: https://vercel.com/support
- **Domain Registrar**: (your registrar)
- **Backup Access**: Stored in password manager