# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

AI Study Architect - A 7-agent educational system that builds cognitive strength, not cognitive debt. Uses Claude (primary) and OpenAI (fallback) to provide Socratic questioning and deep understanding of uploaded course materials. Live at https://ai-study-architect.onrender.com

**Core Principle**: Students upload their materials, AI asks questions (not answers), building understanding through guided discovery.

## Deployment Configuration (CRITICAL - READ FIRST)

### Render Dashboard Settings (Must Match Exactly)
**Source of Truth**: `backend/RENDER_SETTINGS.md`

```
Root Directory: project/backend
Build Command: chmod +x build_starter.sh && ./build_starter.sh
Pre-Deploy Command: (MUST BE EMPTY - leave blank)
Start Command: chmod +x start_render.sh && ./start_render.sh
Instance Type: Starter ($7/month)
```

**IMPORTANT**: 
- Pre-Deploy MUST be empty (database has existing tables, Alembic fails with "relation exists")
- We're on Starter plan, NOT free tier (has SSH access, no spin-down)
- Build uses `build_starter.sh` (attempts PostgreSQL 17 install for Starter plan)

### Required Environment Variables on Render
```bash
# Database (auto-configured)
DATABASE_URL=postgresql://...  # From Render database

# AI Services (REQUIRED)
ANTHROPIC_API_KEY=sk-ant-xxx   # Primary AI
OPENAI_API_KEY=sk-xxx          # Fallback AI

# Backup System
BACKUP_TOKEN=<match GitHub secret>
AWS_ACCESS_KEY_ID=<your AWS key>
AWS_SECRET_ACCESS_KEY=<your AWS secret>
AWS_BACKUP_BUCKET=ai-study-architect-backup-2025
BACKUP_ENCRYPTION_KEY=<generate with: openssl rand -base64 32>

# Auto-generated
SECRET_KEY=<auto-generated>
JWT_SECRET_KEY=<auto-generated>
```

## Backup System

### Architecture
- **Trigger**: GitHub Actions (daily 2 AM UTC) → API endpoint → Backup runs on Render
- **Storage**: AWS S3 bucket (encrypted)
- **Rate Limit**: 1 hour between backups
- **Authentication**: Token-based (X-Backup-Token header)

### Key Files
- `scripts/backup_database.py` - Main backup script (Python fallback for pg_dump version mismatch)
- `app/api/v1/endpoints/backup.py` - API endpoint with rate limiting
- `.github/workflows/backup.yml` - GitHub Actions workflow

### Known Issues & Solutions
- **PostgreSQL Version Mismatch**: Database is v17, client is v16 on Render
  - Solution: Python-based backup using psycopg2 (fallback in backup script)
- **Alembic "relation exists"**: Database created before Alembic was added
  - Solution: Leave Pre-Deploy command empty, handle in start_render.sh

### Testing Backup
```bash
# Test backup manually
curl -X POST -H "X-Backup-Token: YOUR_TOKEN" \
  https://ai-study-architect.onrender.com/api/v1/backup/trigger

# Check backup configuration
curl -X POST -H "X-Backup-Token: YOUR_TOKEN" \
  https://ai-study-architect.onrender.com/api/v1/backup/test
```

## Common Development Commands

### Backend (FastAPI)
```bash
cd backend
uvicorn app.main:app --reload  # Start dev server
pytest tests/                   # Run tests
ruff check app/                  # Lint code
alembic upgrade head            # Run migrations (fails in production due to existing tables)
venv\Scripts\python.exe quick_socratic_test.py  # Test Socratic mode (Windows)
```

### Frontend (React/TypeScript)
```bash
cd frontend
npm run dev          # Start dev server
npm test            # Run tests
npm run typecheck   # Check types
npm run lint        # Lint code
npm run build       # Production build
```

### Quick Health Check
```bash
curl https://ai-study-architect.onrender.com/api/v1/health
curl http://localhost:8000/api/v1/health  # Local
```

## Architecture

### Tech Stack
- **Backend**: FastAPI (sync mode for Windows), PostgreSQL 17, JWT auth (RS256)
- **Frontend**: React 18, TypeScript, Material-UI, React Query, Axios
- **AI**: Claude API (primary, 93.7% HumanEval), OpenAI (fallback), LangChain
- **Deployment**: Render Starter plan (backend), Vercel (frontend planned)
- **Backups**: AWS S3 with encryption, Python-based (pg_dump fallback)

### 7-Agent System
1. **Lead Tutor** (`/api/v1/agents/chat`) - Socratic questioning ✅
2. **Content Understanding** - Multimodal processing (planned)
3. **Knowledge Synthesis** (`/api/v1/agents/explain`) - Personalized materials ✅
4. **Practice Generation** (`/api/v1/agents/study-plan`) - Adaptive problems ✅
5. **Progress Tracking** (`/api/v1/agents/status`) - Difficulty adjustment ✅
6. **Assessment** (`/api/v1/agents/check-understanding`) - True comprehension ✅
7. **Collaboration** (`/api/v1/agents/clear-memory`) - Collective intelligence ✅

### Project Structure
```
project/
├── backend/
│   ├── app/
│   │   ├── api/v1/       # API endpoints
│   │   │   └── endpoints/
│   │   │       └── backup.py  # Backup API endpoint
│   │   ├── agents/       # 7-agent implementations
│   │   ├── core/         # Config, security, database
│   │   │   └── csrf.py   # CSRF protection with exemptions
│   │   ├── models/       # SQLAlchemy models
│   │   ├── schemas/      # Pydantic schemas
│   │   └── services/     # AI services, processors
│   ├── scripts/
│   │   ├── backup_database.py    # Main backup script
│   │   ├── generate_rsa_keys.py  # JWT key generation
│   │   └── fix_alembic_state.py  # One-time fix (can be removed)
│   ├── alembic/          # Database migrations
│   ├── tests/            # Pytest suite
│   ├── RENDER_SETTINGS.md  # Render config source of truth
│   ├── build_starter.sh    # Build script for Starter plan
│   ├── start_render.sh     # Production start script
│   └── .gitattributes     # Force Unix line endings
└── frontend/
    ├── src/
    │   ├── components/   # React components
    │   ├── services/     # API clients
    │   ├── hooks/        # Custom React hooks
    │   └── types/        # TypeScript definitions
    └── public/           # Static assets
```

## Platform-Specific Notes

### Windows Development
- **PostgreSQL**: Default port 5433 (not 5432)
- **Python**: Use `venv\Scripts\python.exe` explicitly
- **Line Endings**: .gitattributes enforces LF for shell scripts
- **Passwords**: Special chars need `quote_plus()` encoding

### Render Platform Constraints
- **No root access**: Cannot install system packages in build
- **PostgreSQL client**: Version 16 installed (database is v17)
- **Build restrictions**: Use Python packages, not apt-get
- **Starter plan benefits**: SSH access, no spin-down, persistent disk

## Common Issues & Solutions

| Issue | Solution |
|-------|----------|
| PostgreSQL version mismatch | Python backup using psycopg2 (automatic fallback) |
| Alembic "relation exists" | Leave Pre-Deploy empty, use start_render.sh |
| bash\r: No such file or directory | .gitattributes enforces Unix line endings |
| CSRF 403 on backup | Backup endpoint exempt in csrf.py |
| Build fails on apt-get | Render has no root; use Python alternatives |
| Rate limit on backup | Wait 1 hour between manual triggers |
| S3 bucket not found | Set AWS_BACKUP_BUCKET env var |

## Security Configuration

### CSRF Protection
Exempted paths (in `app/core/csrf.py`):
- `/api/v1/backup/` - Uses token authentication
- `/api/v1/auth/*` - Login/register endpoints
- `/api/v1/content/upload` - File upload with JWT
- `/docs`, `/redoc`, `/openapi.json` - Documentation

### Authentication Methods
- **User endpoints**: JWT (RS256) with auto-generated keys
- **Backup endpoint**: Token in X-Backup-Token header
- **Rate limiting**: All endpoints, backup limited to 1/hour

## Testing Scripts to Keep
- `tests/scripts/quick_socratic_test.py` - Socratic mode testing
- `tests/scripts/test_requirements.py` - Dependency checking

## Files to Clean Up (Safe to Remove)
- `start.sh` - Obsolete, use start_render.sh
- `start_render_simple.sh` - Obsolete simplified version
- `scripts/one_time_fix.sh` - Already executed
- `scripts/fix_alembic_state.py` - Already executed
- `alembic/env_original.py` - Backup no longer needed

## Critical Reminders

- **Pre-Deploy MUST be empty** - Any migration command fails
- **Use start_render.sh** - Has error handling for existing tables
- **PostgreSQL mismatch is OK** - Python backup handles it
- **Check RENDER_SETTINGS.md** - Before changing Render dashboard
- **Backup token in BOTH places** - GitHub secrets AND Render env
- **Port 5433** not 5432 on Windows PostgreSQL
- **7 agents** always (not 5 or 6)

## Deployment Process

```bash
# Any code change
git add -A
git commit -m "Description"
git push origin main
# Render auto-deploys from main branch

# After deployment
curl https://ai-study-architect.onrender.com/api/v1/health
```

## Session History

Key milestones:
- Session 18-20: MIT cognitive debt research
- Session 21-23: Claude integration, initial deployment
- Session 24: Removed Ollama, fixed models/ git issue
- Session 25: Backup system implementation, PostgreSQL workarounds
- Session 26+: Production hardening, rate limiting, documentation

## Project Philosophy

**Problem**: AI Learning Paradox - students use AI but perform worse without it (78% recall failure - MIT study)
**Solution**: 7-agent system that builds thinking skills through Socratic method
**Difference**: Uses YOUR materials, builds cognitive strength, discovers patterns

"AI Study Architect builds cognitive strength, not cognitive debt"